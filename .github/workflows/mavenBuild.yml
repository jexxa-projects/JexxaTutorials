# This workflow will build a Java project with Maven
# For more information see: https://help.github.com/actions/language-and-framework-guides/building-and-testing-java-with-maven

name: Maven Test Build

on:
  push:
  workflow_dispatch:

jobs:
  linux_build:
    name: Linux-Test
    runs-on: ubuntu-latest

    # Service containers to run with `runner-job`
    services:
      activemq:
        image: quay.io/artemiscloud/activemq-artemis-broker:latest
        ports:
          - 61616:61616
        env:
          AMQ_USER: admin
          AMQ_PASSWORD: admin

      postgres:
        image: postgres
        ports:
          - 5432:5432
        env:
          POSTGRES_PASSWORD: admin
          POSTGRES_USER: postgres
      minio:
        image: lazybit/minio
        ports:
          - 8100:9000
          - 8101:9001
        env:
          MINIO_ROOT_USER: minioadmin      # Admin Access Key
          MINIO_ROOT_PASSWORD: minioadmin

    steps:
      - name: Start Redpanda with Schema Registry
        run: |
          docker run -d --name redpanda \
            -p 9092:9092 \
            -p 8081:8081 \
            --health-cmd="rpk cluster info" \
            --health-interval=5s \
            --health-retries=20 \
            redpandadata/redpanda:latest \
            redpanda start \
              --overprovisioned \
              --smp 1 \
              --memory 1G \
              --reserve-memory 0M \
              --node-id 0 \
              --kafka-addr PLAINTEXT://0.0.0.0:9092 \
              --advertise-kafka-addr PLAINTEXT://localhost:9092 \
              --schema-registry-addr 0.0.0.0:8081

      - name: Wait for Redpanda to be healthy
        run: |
          echo "Waiting for Redpanda to be healthy..."
          for i in {1..30}; do  # ~60s Timeout
            if [ "$(docker inspect -f '{{.State.Health.Status}}' redpanda 2>/dev/null)" = "healthy" ]; then
              echo "✅ Redpanda is healthy!"
              exit 0
            fi
            echo "⏳ Still waiting..."
            sleep 2
          done
          echo "❌ Timeout: Redpanda did not become healthy in time"
          exit 1

      - uses: actions/checkout@v6
      - name: Set up JDK 25
        uses: actions/setup-java@v5
        with:
          java-version: 25
          distribution: 'corretto'
      - name: Build with Maven
        run: mvn -B install --file pom.xml


